(function($){$.fn.scratch=function(options){var $container=this;var defaluts={cover:"",ID:"canvas",width:"",height:"",ratio:.5,resultData:function(){},resultOperate:function(data){},endOperate:function(){},touchRadius:parseInt(window.getComputedStyle(document.documentElement,null)["font-size"])};var opts=$.extend(defaluts,options);var c1;var ctx;var ismousedown=false;var isOk=true;var isFirst=true;var _reColor=/^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})$/,oX=$container[0].offsetLeft,oY=$container[0].offsetTop;var prototype=function(){window.onload=function(){var _HTML='<canvas style="width:100%" id="'+opts.ID+'">你的浏览器不支持canvas</canvas>';$container.css({position:"relative"}).html(_HTML);canvas=document.getElementById(opts.ID);ctx=canvas.getContext("2d");if(!isNaN(opts.width)&&!isNaN(opts.height)&&opts.width!=""&&opts.height!=""){var _re=opts.width/opts.height;canvas.width=canvas.clientWidth;canvas.height=canvas.clientWidth/_re;ctx.globalCompositeOperation="source-over";if(_reColor.test(opts.cover)){ctx.fillStyle=opts.cover;ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);ctx.globalCompositeOperation="destination-out";}else{var _img=new Image();_img.onload=function(){ctx.drawImage(_img,0,0,canvas.clientWidth,canvas.clientHeight);ctx.globalCompositeOperation="destination-out";};_img.src=opts.cover;}
canvas.addEventListener("mousemove",eventMove,false);canvas.addEventListener("mousedown",eventDown,false);canvas.addEventListener("mouseup",eventUp,false);canvas.addEventListener("touchstart",eventDown,false);canvas.addEventListener("touchend",eventUp,false);canvas.addEventListener("touchmove",eventMove,false);}else{console.error("参数错误:width,height");}};};var eventDown=function(e){e.preventDefault();if(isOk){ismousedown=true;if(isFirst){isFirst=false;var _result=opts.resultData();$(canvas).css({background:"url("+_result.img+") no-repeat center center/100% 100%"});opts.resultOperate(_result);}}};var eventMove=function(e){e.preventDefault();if(ismousedown){if(e.changedTouches){e=e.changedTouches[e.changedTouches.length-1];}
var x=(e.clientX+document.body.scrollLeft||e.pageX)-oX||0,y=(e.clientY+document.body.scrollTop||e.pageY)-oY||0;ctx.beginPath();ctx.arc(x,y,opts.touchRadius*1.2*2,0,Math.PI*2,true);canvas.style.display="none";canvas.offsetHeight;canvas.style.display="inherit";ctx.fill();}};var eventUp=function(e){e.preventDefault();if(ismousedown){var canvasDate=ctx.getImageData(0,0,canvas.width,canvas.height),canvasDateLength=canvasDate.data.length;var j=0;for(var i=3;i<canvasDateLength;i+=4){if(canvasDate.data[i]==0){j++;}}
if(j>=canvasDateLength/4*opts.ratio){isOk=1;ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);opts.endOperate();}
ismousedown=false;}};return prototype();};})(jQuery,window,document);